<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Pocket Tournament Points System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <div class="pokedex-container">
        <img id="logo" src="pocketlogo.jpg" alt="Pokémon TCG Logo">
        <h1>Pokémon TCG Pocket Tournament Points System</h1>
        <div id="homePage" class="section pokedex-section">
            <button class="pokeball-btn" onclick="showPlayerView()">Player</button>
            <button class="pokeball-btn" onclick="showRedeemableItems()">Redeemable Items</button>
            <button id="toggleMusic" class="pokeball-btn" onclick="toggleMusic()">Toggle Music</button>
        </div>

        <audio id="backgroundMusic" loop>
            <source src="https://www.pokemon.com/static-assets/content/legacy/pokemon-game-sound-library-en_us.zip" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        <!-- Player View Section: Displays leaderboard with search bar and player details -->
        <div id="playerView" class="section pokedex-section hidden">
            <h2>Player Leaderboard</h2>
            <div id="kingOfTournament" class="king-table"></div>
            <div class="search-bar">
                <label for="leaderboardSearch">Search Player:</label>
                <input type="text" id="leaderboardSearch" oninput="filterLeaderboard()" placeholder="Enter player name">
            </div>
            <div class="table-container">
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="firstPage" onclick="changePage(0)">First Page</button>
                <button id="prevPage" onclick="changePage(-1)">Previous</button>
                <span id="pageInfo"></span>
                <button id="nextPage" onclick="changePage(1)">Next</button>
                <button id="lastPage" onclick="changePage(999)">Last Page</button>
            </div>
            <div class="button-group">
                <button class="back-button pokeball-btn" onclick="backToHome()">Back to Home</button>
                <button class="pokeball-btn" onclick="alert('Feature coming soon!')">View Summary</button>
            </div>
            <div id="playerDetails" class="section pokedex-section hidden">
                <h3 id="playerDetailsName"></h3>
                <div id="playerProfileCard" class="pokemon-card"></div>
                <div class="table-container">
                    <table id="detailsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>P.Streak</th>
                                <th>P.Participant</th>
                                <th>1st</th>
                                <th>2nd</th>
                                <th>3rd</th>
                                <th>B.Cha.</th>
                                <th>S.Cha.</th>
                                <th>Shared</th>
                                <th>No s.s.</th>
                                <th>Penalty</th>
                                <th>Redeemed Items</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button id="firstDetailsPage" onclick="changeDetailsPage(0)">First Page</button>
                    <button id="prevDetailsPage" onclick="changeDetailsPage(-1)">Previous</button>
                    <span id="detailsPageInfo"></span>
                    <button id="nextDetailsPage" onclick="changeDetailsPage(1)">Next</button>
                    <button id="lastDetailsPage" onclick="changeDetailsPage(999)">Last Page</button>
                </div>
                <div class="button-group">
                    <button class="back-button pokeball-btn" onclick="backToLeaderboard()">Back to Leaderboard</button>
                    <button class="back-button pokeball-btn" onclick="backToHome()">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Redeemable Items Section: Displays available items for players to view -->
        <div id="redeemableItems" class="section pokedex-section hidden">
            <h2>Redeemable Items</h2>
            <div class="table-container">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Points</th>
                            <th>Item</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>5500</td><td>Random SV Booster Box X 1</td></tr>
                        <tr><td>1300</td><td>Random SV Booster Bundle X 1</td></tr>
                        <tr><td>1000</td><td>Mystery Gift X 10 (Guaranteed Hits in 2)</td></tr>
                        <tr><td>600</td><td>Random SV Booster Pack X 3</td></tr>
                        <tr><td>400</td><td>Discover Collectibles Playmat X 1</td></tr>
                        <tr><td>300</td><td>Mystery Gift X 3 (High Chance Hits in 1)</td></tr>
                        <tr><td>220</td><td>Random SV Booster Pack X 1</td></tr>
                        <tr><td>100</td><td>Mystery Gift X 1</td></tr>
                        <tr><td>20</td><td>Bro Hug X 1</td></tr>
                    </tbody>
                </table>
            </div>
            <button class="back-button pokeball-btn" onclick="backToHome()">Back to Home</button>
        </div>

        <!-- JavaScript: Handles player view and redeemable items -->
        <script>
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOOrxR0LvEzwE_1bh_pK9o_0w0I6_OsvltPXbKsHrWgXbkScP2-YBdr9qKZKps6fDY-6lxvUya7-bB/pub?output=csv'; // Replace with your published CSV URL
            let data = [];
            let currentPage = 1;
            let currentDetailsPage = 1;
            const entriesPerPage = 10; // Players per page
            const detailsPerPage = 20; // Details per page
            let currentPlayers = [];
            let musicPlaying = false;

            // Debug function to log data issues
            function debugLog(message) {
                console.log(`[DEBUG ${new Date().toLocaleString()} +08] ${message}`);
            }

            // Utility to normalize date to YYYY-MM-DD
            function normalizeDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return isNaN(date) ? '' : date.toISOString().split('T')[0]; // Returns YYYY-MM-DD or empty if invalid
            }

            // Load data from Google Sheets CSV using PapaParse
            async function loadData() {
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${CSV_URL}`);
                    }
                    const csvText = await response.text();
                    debugLog(`Raw CSV data: ${csvText.substring(0, 200)}...`); // Log first 200 chars
                    const parsed = Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        quotes: true,
                        delimiter: ',',
                    });
                    if (parsed.errors.length > 0) {
                        throw new Error(`Papa Parse errors: ${JSON.stringify(parsed.errors)}`);
                    }
                    data = parsed.data.map(entry => {
                        // Create achievements object from checkbox columns
                        entry.achievements = {
                            'P.Streak': entry['P.Streak'] || false,
                            'P.Participant': entry['P.Participant'] || false,
                            '1st': entry['1st'] || false,
                            '2nd': entry['2nd'] || false,
                            '3rd': entry['3rd'] || false,
                            'B.Challenge': entry['B.Challenge'] || false,
                            'S.Challenge': entry['S.Challenge'] || false,
                            'Shared': entry['Shared'] || false,
                            'No s.s.': entry['No s.s.'] || false,
                            'Penalty': entry['Penalty'] || false,
                        };
                        if (entry.items) {
                            let rawValue = entry.items;
                            rawValue = rawValue.replace(/""/g, '"').replace(/^"|"$/g, '');
                            try {
                                entry.items = JSON.parse(rawValue || '[]');
                                debugLog(`Parsed items: ${JSON.stringify(entry.items)}`);
                            } catch (e) {
                                debugLog(`Error parsing items: ${rawValue}, error: ${e.message}`);
                                entry.items = [];
                            }
                        }
                        entry.date = normalizeDate(entry.date);
                        entry.isRedemption = entry.isRedemption === true || entry.isRedemption === 'TRUE';
                        entry.points = Number(entry.points) || 0;
                        return entry;
                    });
                    debugLog(`Loaded data from CSV: ${data.length} entries`);
                    renderLeaderboard();
                } catch (error) {
                    debugLog(`Error loading data: ${error.message}`);
                    alert('Failed to load data. Please try again.');
                    data = [];
                    renderLeaderboard();
                }
            }

            function toggleMusic() {
                const music = document.getElementById('backgroundMusic');
                if (musicPlaying) {
                    music.pause();
                    musicPlaying = false;
                    document.getElementById('toggleMusic').textContent = 'Play Music';
                } else {
                    music.play();
                    musicPlaying = true;
                    document.getElementById('toggleMusic').textContent = 'Pause Music';
                }
            }

            function backToHome() {
                hideAll();
                document.getElementById('homePage').classList.remove('hidden');
                document.getElementById('playerDetails').classList.add('hidden');
                document.getElementById('leaderboardSearch').value = '';
                currentPage = 1;
                renderLeaderboard();
            }

            function showPlayerView() {
                debugLog('showPlayerView triggered');
                hideAll();
                document.getElementById('playerView').classList.remove('hidden');
                setTimeout(() => document.getElementById('playerView').classList.add('fade-in'), 10);
                document.getElementById('playerDetails').classList.add('hidden');
                document.getElementById('leaderboardSearch').value = '';
                currentPage = 1;
                renderLeaderboard();
            }

            function showRedeemableItems() {
                hideAll();
                document.getElementById('redeemableItems').classList.remove('hidden');
                setTimeout(() => document.getElementById('redeemableItems').classList.add('fade-in'), 10);
            }

            function hideAll() {
                document.querySelectorAll('.section:not(.hidden)').forEach(el => {
                    el.classList.add('fade-out');
                    setTimeout(() => {
                        el.classList.add('hidden');
                        el.classList.remove('fade-out', 'fade-in');
                    }, 300);
                });
            }

            function renderLeaderboard() {
                debugLog(`Rendering leaderboard, data length: ${data.length}`);
                const searchTerm = document.getElementById('leaderboardSearch').value.trim().toLowerCase();
                const players = {};
                data.filter(e => !e.isRedemption).forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) {
                        players[playerLower] = { name: entry.player, total: 0 };
                    }
                    players[playerLower].total += (entry.points || 0);
                });
                data.filter(e => e.isRedemption).forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) {
                        players[playerLower] = { name: entry.player, total: 0 };
                    }
                    players[playerLower].total += (entry.points || 0);
                });
                currentPlayers = Object.values(players).sort((a, b) => b.total - a.total);

                // Calculate King of the Tournament stats
                const achievementCounts = {};
                data.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!achievementCounts[playerLower]) {
                        achievementCounts[playerLower] = {
                            '1st': 0, '2nd': 0, '3rd': 0, 'B.Challenge': 0, 'S.Challenge': 0
                        };
                    }
                    if (entry.achievements['1st']) achievementCounts[playerLower]['1st']++;
                    if (entry.achievements['2nd']) achievementCounts[playerLower]['2nd']++;
                    if (entry.achievements['3rd']) achievementCounts[playerLower]['3rd']++;
                    if (entry.achievements['B.Challenge']) achievementCounts[playerLower]['B.Challenge']++;
                    if (entry.achievements['S.Challenge']) achievementCounts[playerLower]['S.Challenge']++;
                });
                const kings = {
                    '1st': Object.entries(achievementCounts).sort((a, b) => b[1]['1st'] - a[1]['1st'])[0],
                    '2nd': Object.entries(achievementCounts).sort((a, b) => b[1]['2nd'] - a[1]['2nd'])[0],
                    '3rd': Object.entries(achievementCounts).sort((a, b) => b[1]['3rd'] - a[1]['3rd'])[0],
                    'B.Challenge': Object.entries(achievementCounts).sort((a, b) => b[1]['B.Challenge'] - a[1]['B.Challenge'])[0],
                    'S.Challenge': Object.entries(achievementCounts).sort((a, b) => b[1]['S.Challenge'] - a[1]['S.Challenge'])[0]
                };
                const kingTable = document.getElementById('kingOfTournament');
                kingTable.innerHTML = `
                    <h3>King of the Tournament</h3>
                    <table>
                        <tr><th>Category</th><th>Player</th><th>Count</th></tr>
                        <tr><td>1st Place</td><td>${kings['1st'][0]}</td><td>${kings['1st'][1]['1st']}</td></tr>
                        <tr><td>2nd Place</td><td>${kings['2nd'][0]}</td><td>${kings['2nd'][1]['2nd']}</td></tr>
                        <tr><td>3rd Place</td><td>${kings['3rd'][0]}</td><td>${kings['3rd'][1]['3rd']}</td></tr>
                        <tr><td>Big Challenge</td><td>${kings['B.Challenge'][0]}</td><td>${kings['B.Challenge'][1]['B.Challenge']}</td></tr>
                        <tr><td>Small Challenge</td><td>${kings['S.Challenge'][0]}</td><td>${kings['S.Challenge'][1]['S.Challenge']}</td></tr>
                    </table>
                `;

                if (searchTerm) {
                    currentPlayers = currentPlayers.filter(p => p.name.toLowerCase().includes(searchTerm));
                }
                const totalPages = Math.ceil(currentPlayers.length / entriesPerPage);
                const start = (currentPage - 1) * entriesPerPage;
                const end = start + entriesPerPage;
                const paginatedPlayers = currentPlayers.slice(start, end);
                const tbody = document.getElementById('leaderboardTable').querySelector('tbody');
                tbody.innerHTML = '';
                if (paginatedPlayers.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="3">No players found.</td>';
                    tbody.appendChild(tr);
                    debugLog('No players to display in leaderboard');
                } else {
                    paginatedPlayers.forEach((p, index) => {
                        const globalIndex = start + index + 1;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${globalIndex}</td>
                            <td><a href="#" onclick="showPlayerDetails('${p.name}', 1)">${p.name}</a></td>
                            <td>${p.total}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    debugLog(`Rendered ${paginatedPlayers.length} players on page ${currentPage}`);
                }
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
                document.getElementById('firstPage').disabled = currentPage === 1;
                document.getElementById('prevPage').disabled = currentPage === 1;
                document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
                document.getElementById('lastPage').disabled = currentPage === totalPages || totalPages === 0;
            }

            function filterLeaderboard() {
                currentPage = 1;
                renderLeaderboard();
            }

            function showPlayerDetails(player, page = 1) {
                debugLog(`Showing details for player: ${player}, page: ${page}`);
                currentDetailsPage = page;
                document.getElementById('playerDetailsName').textContent = `${player} Details`;
                const entries = data.filter(e => e.player.toLowerCase() === player.toLowerCase()).sort((a, b) => new Date(b.date) - new Date(a.date));
                const totalPages = Math.ceil(entries.length / detailsPerPage);
                const start = (currentDetailsPage - 1) * detailsPerPage;
                const end = start + detailsPerPage;
                const paginatedEntries = entries.slice(start, end);
                const tbody = document.getElementById('detailsTable').querySelector('tbody');
                tbody.innerHTML = '';

                // Calculate player stats for profile card
                const playerStats = {
                    totalPoints: 0,
                    achievements: {
                        '1st': 0,
                        '2nd': 0,
                        '3rd': 0,
                        'B.Challenge': 0,
                        'S.Challenge': 0,
                        'P.Streak': 0,
                        'P.Participant': 0
                    }
                };
                entries.forEach(entry => {
                    playerStats.totalPoints += entry.points || 0;
                    for (let ach in playerStats.achievements) {
                        if (entry.achievements[ach]) playerStats.achievements[ach]++;
                    }
                });

                // Render player profile card
                const profileCard = document.getElementById('playerProfileCard');
                profileCard.innerHTML = `
                    <div class="pokemon-card-content">
                        <h4>${player}'s Profile</h4>
                        <p>Total Points: ${playerStats.totalPoints}</p>
                        <p>Achievements:</p>
                        <p>1st x${playerStats.achievements['1st']}</p>
                        <p>2nd x${playerStats.achievements['2nd']}</p>
                        <p>3rd x${playerStats.achievements['3rd']}</p>
                        <p>B.Challenge x${playerStats.achievements['B.Challenge']}</p>
                        <p>S.Challenge x${playerStats.achievements['S.Challenge']}</p>
                        <p>P.Streak x${playerStats.achievements['P.Streak']}</p>
                        <p>Participant x${playerStats.achievements['P.Participant']}</p>
                    </div>
                `;

                if (paginatedEntries.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="13">No entries found for this player.</td>';
                    tbody.appendChild(tr);
                } else {
                    paginatedEntries.forEach(entry => {
                        debugLog(`Processing entry for ${entry.player}: ${JSON.stringify(entry)}`);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${normalizeDate(entry.date)}</td>`;
                        // Map checkbox fields to O/X
                        tr.innerHTML += `<td>${entry.achievements['P.Streak'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['P.Participant'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['1st'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['2nd'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['3rd'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['B.Challenge'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['S.Challenge'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['Shared'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['No s.s.'] ? 'O' : 'X'}</td>`;
                        tr.innerHTML += `<td>${entry.achievements['Penalty'] ? 'O' : 'X'}</td>`;
                        const itemsText = entry.isRedemption ? (entry.items || []).map(item => `${item.name} (x${item.quantity || 1})`).join('<br>') : '-';
                        tr.innerHTML += `<td>${itemsText}</td><td>${entry.points}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('detailsPageInfo').textContent = `Page ${currentDetailsPage} of ${totalPages || 1}`;
                document.getElementById('firstDetailsPage').disabled = currentDetailsPage === 1;
                document.getElementById('prevDetailsPage').disabled = currentDetailsPage === 1;
                document.getElementById('nextDetailsPage').disabled = currentDetailsPage === totalPages || totalPages === 0;
                document.getElementById('lastDetailsPage').disabled = currentDetailsPage === totalPages || totalPages === 0;
                document.getElementById('playerDetails').classList.remove('hidden');
                setTimeout(() => document.getElementById('playerDetails').classList.add('fade-in'), 10);
            }

            function changePage(direction) {
                const totalPages = Math.ceil(currentPlayers.length / entriesPerPage);
                if (direction === 0) currentPage = 1; // First Page
                else if (direction === 999) currentPage = totalPages || 1; // Last Page
                else currentPage += direction;
                currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
                renderLeaderboard();
            }

            function changeDetailsPage(direction) {
                const player = document.getElementById('playerDetailsName').textContent.replace(' Details', '');
                const entries = data.filter(e => e.player.toLowerCase() === player.toLowerCase());
                const totalPages = Math.ceil(entries.length / detailsPerPage);
                if (direction === 0) currentDetailsPage = 1; // First Page
                else if (direction === 999) currentDetailsPage = totalPages || 1; // Last Page
                else currentDetailsPage += direction;
                currentDetailsPage = Math.max(1, Math.min(currentDetailsPage, totalPages || 1));
                showPlayerDetails(player, currentDetailsPage);
            }

            function backToLeaderboard() {
                document.getElementById('playerDetails').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('playerDetails').classList.add('hidden');
                    document.getElementById('playerDetails').classList.remove('fade-out', 'fade-in');
                    renderLeaderboard();
                }, 300);
            }

            // Initialize leaderboard on page load
            document.addEventListener('DOMContentLoaded', () => {
                debugLog('Page loaded, initializing leaderboard');
                loadData();
                document.getElementById('backgroundMusic').play();
                musicPlaying = true;
                document.getElementById('toggleMusic').textContent = 'Pause Music';
            });
        </script>
    </div>
</body>
</html>
