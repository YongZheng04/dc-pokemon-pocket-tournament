<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Pocket Tournament Points System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <div class="pokedex-container">
        <img id="logo" src="pocketlogo.jpg" alt="Pokémon TCG Logo">
        <h1>Pokémon TCG Pocket Tournament Points System</h1>
        <div id="homePage" class="section pokedex-section">
            <div class="button-row">
                <button class="game-btn" onclick="showPlayerView()">Player</button>
                <button class="game-btn" onclick="showOverview()">Overview</button>
                <button class="game-btn" onclick="showPlayerComparison()">Player Comparison</button>
                <button class="game-btn" onclick="showTournamentHistory()">Tournament History</button>
                <button class="game-btn" onclick="showFunFact()">Random Fun Fact</button>
            </div>
        </div>

        <!-- Player View Section -->
        <div id="playerView" class="section pokedex-section hidden">
            <h2>Player Leaderboard</h2>
            <div class="search-bar">
                <label for="leaderboardSearch">Search Player: (Click name for details)</label>
                <input type="text" id="leaderboardSearch" oninput="filterLeaderboard()" placeholder="Enter player name">
            </div>
            <div class="table-container">
                <table id="leaderboardTable" class="game-leaderboard">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="firstPage" onclick="changePage(0)">First Page</button>
                <button id="prevPage" onclick="changePage(-1)">Previous</button>
                <span id="pageInfo"></span>
                <button id="nextPage" onclick="changePage(1)">Next</button>
                <button id="lastPage" onclick="changePage(999)">Last Page</button>
            </div>
            <div class="button-group">
                <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
            </div>
            <div id="playerDetails" class="section pokedex-section hidden">
                <h3 id="playerDetailsName"></h3>
                <div id="playerProfileCard" class="pokemon-card"></div>
                <div class="table-container">
                    <table id="detailsTable" class="game-leaderboard">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>P.Streak</th>
                                <th>P.Participant</th>
                                <th>1st</th>
                                <th>2nd</th>
                                <th>3rd</th>
                                <th>B.Cha.</th>
                                <th>S.Cha.</th>
                                <th>Shared</th>
                                <th>No s.s.</th>
                                <th>Penalty</th>
                                <th>Redeemed Items</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button id="firstDetailsPage" onclick="changeDetailsPage(0)">First Page</button>
                    <button id="prevDetailsPage" onclick="changeDetailsPage(-1)">Previous</button>
                    <span id="detailsPageInfo"></span>
                    <button id="nextDetailsPage" onclick="changeDetailsPage(1)">Next</button>
                    <button id="lastDetailsPage" onclick="changeDetailsPage(999)">Last Page</button>
                </div>
                <div class="button-group">
                    <button class="back-button game-btn" onclick="backToLeaderboard()">Back to Leaderboard</button>
                    <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overviewView" class="section pokedex-section hidden">
            <h2>Overview</h2>
            <div id="tournamentStats" class="pokemon-leaderboard"></div>
            <div id="redeemableSummary" class="pokemon-leaderboard"></div>
            <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
        </div>

        <!-- Player Comparison Section -->
        <div id="playerComparisonView" class="section pokedex-section hidden">
            <h2>Player Comparison Tool</h2>
            <div class="battle-arena">
                <div class="search-bar">
                    <label for="player1Select">Player 1:</label>
                    <select id="player1Select" onchange="comparePlayers()">
                        <option value="">Select Player</option>
                    </select>
                </div>
                <div class="vs-text">VS</div>
                <div class="search-bar">
                    <label for="player2Select">Player 2:</label>
                    <select id="player2Select" onchange="comparePlayers()">
                        <option value="">Select Player</option>
                    </select>
                </div>
            </div>
            <div id="comparisonResult" class="battle-result"></div>
            <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
        </div>

        <!-- Tournament History Section -->
        <div id="tournamentHistoryView" class="section pokedex-section hidden">
            <h2>Tournament History Timeline</h2>
            <div class="search-bar">
                <label for="dateSelect">Select Tournament Date:</label>
                <select id="dateSelect" onchange="filterHistory()">
                    <option value="">Select Date</option>
                </select>
            </div>
            <div id="historyTimeline" class="pokedex-log"></div>
            <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
        </div>

        <!-- Random Fun Fact Section -->
        <div id="funFactView" class="section pokedex-section hidden">
            <h2>Random Fun Fact</h2>
            <div id="funFactText" class="troll-note"></div>
            <button class="game-btn" onclick="generateFunFact()">Generate New Fact</button>
            <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
        </div>

        <script>
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOOrxR0LvEzwE_1bh_pK9o_0w0I6_OsvltPXbKsHrWgXbkScP2-YBdr9qKZKps6fDY-6lxvUya7-bB/pub?output=csv'; // Replace with your published CSV URL
            let data = [];
            let currentPage = 1;
            let currentDetailsPage = 1;
            const entriesPerPage = 10;
            const detailsPerPage = 10;
            let currentPlayers = [];
            let filteredPlayers = [];

            function debugLog(message) {
                console.log(`[DEBUG ${new Date().toLocaleString()} +08] ${message}`);
            }

            function normalizeDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return isNaN(date) ? '' : date.toISOString().split('T')[0];
            }

            async function loadData() {
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText} - ${CSV_URL}`);
                    const csvText = await response.text();
                    debugLog(`Raw CSV data: ${csvText.substring(0, 200)}...`);
                    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: true, quotes: true, delimiter: ',' });
                    if (parsed.errors.length > 0) throw new Error(`Papa Parse errors: ${JSON.stringify(parsed.errors)}`);
                    data = parsed.data.map(entry => {
                        entry.achievements = {
                            'P.Streak': entry['P.Streak'] || false,
                            'P.Participant': entry['P.Participant'] || false,
                            '1st': entry['1st'] || false,
                            '2nd': entry['2nd'] || false,
                            '3rd': entry['3rd'] || false,
                            'B.Challenge': entry['B.Challenge'] || false,
                            'S.Challenge': entry['S.Challenge'] || false,
                            'Shared': entry['Shared'] || false,
                            'No s.s.': entry['No s.s.'] || false,
                            'Penalty': entry['Penalty'] || false,
                        };
                        if (entry.items) {
                            let rawValue = entry.items.replace(/""/g, '"').replace(/^"|"$/g, '');
                            try { entry.items = JSON.parse(rawValue || '[]'); debugLog(`Parsed items: ${JSON.stringify(entry.items)}`); }
                            catch (e) { debugLog(`Error parsing items: ${rawValue}, error: ${e.message}`); entry.items = []; }
                        }
                        entry.date = normalizeDate(entry.date);
                        entry.isRedemption = entry.isRedemption === true || entry.isRedemption === 'TRUE';
                        entry.points = Number(entry.points) || 0;
                        return entry;
                    });
                    debugLog(`Loaded data from CSV: ${data.length} entries`);
                    renderLeaderboard();
                    updateFilteredPlayers();
                    populateDateSelect();
                    populatePlayerSelect();
                } catch (error) {
                    debugLog(`Error loading data: ${error.message}`);
                    alert('Failed to load data. Please try again.');
                    data = [];
                    renderLeaderboard();
                }
            }

            function backToHome() {
                hideAll();
                document.getElementById('homePage').classList.remove('hidden');
                document.getElementById('playerDetails').classList.add('hidden');
                document.getElementById('leaderboardSearch').value = '';
                currentPage = 1;
                renderLeaderboard();
            }

            function showPlayerView() {
                debugLog('showPlayerView triggered');
                hideAll();
                document.getElementById('playerView').classList.remove('hidden');
                setTimeout(() => document.getElementById('playerView').classList.add('fade-in'), 10);
                document.getElementById('playerDetails').classList.add('hidden');
                document.getElementById('leaderboardSearch').value = '';
                currentPage = 1;
                renderLeaderboard();
            }

            function showOverview() {
                debugLog('Showing overview');
                hideAll();
                const totalPoints = data.reduce((sum, entry) => sum + (entry.points || 0), 0);
                const tournamentCount = [...new Set(data.map(entry => entry.date))].length;
                const averagePoints = tournamentCount > 0 ? Math.round(totalPoints / tournamentCount) : 0;
                const players = {};
                data.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                const topPlayers = Object.values(players).sort((a, b) => b.total - a.total).slice(0, 5);
                const pointsByType = {
                    '1st': data.filter(e => e.achievements['1st']).reduce((sum, e) => sum + (e.points || 0), 0),
                    'Redemptions': data.filter(e => e.isRedemption).reduce((sum, e) => sum + (e.points || 0), 0),
                    'Other': totalPoints - (data.filter(e => e.achievements['1st']).reduce((sum, e) => sum + (e.points || 0), 0) + data.filter(e => e.isRedemption).reduce((sum, e) => sum + (e.points || 0), 0))
                };
                const totalSpent = data.filter(e => e.isRedemption).reduce((sum, entry) => sum + (entry.points || 0), 0);
                const itemCounts = {};
                data.filter(e => e.isRedemption && e.items).forEach(entry => {
                    entry.items.forEach(item => {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
                    });
                });
                const mostPopularItem = Object.entries(itemCounts).reduce((a, b) => a[1] > b[1] ? a : b, [null, 0])[0] || 'None';
                const remainingPoints = totalPoints - Math.abs(totalSpent);
                const latestDate = [...new Set(data.map(entry => entry.date))].sort().pop() || '';
                const latestWinner = getTournamentWinner(latestDate);
                const latestTotalPoints = getTournamentTotalPoints(latestDate);
                const achievementSpotlight = getPlayerWithMost('P.Streak');
                const achievementCount = getPlayerAchievementCount(achievementSpotlight, 'P.Streak');

                document.getElementById('overviewView').innerHTML = `
                    <h2>Overview</h2>
                    <div id="tournamentStats" class="pokemon-leaderboard">
                        <h3>Tournament Summary Dashboard</h3>
                        <table>
                            <tr><th>Category</th><th>Value</th></tr>
                            <tr><td>Total Points</td><td>${totalPoints}</td></tr>
                            <tr><td>Tournaments Held</td><td>${tournamentCount}</td></tr>
                            <tr><td>Average Points</td><td>${averagePoints}</td></tr>
                        </table>
                    </div>
                    <div id="topPerformers" class="pokemon-leaderboard">
                        <h3>Top Performers Leaderboard</h3>
                        <table>
                            <tr><th>Rank</th><th>Player</th><th>Points</th><th>Rank Title</th></tr>
                            ${topPlayers.map((p, i) => `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.total}</td><td>${getTrainerRank(p.total)}</td></tr>`).join('')}
                        </table>
                    </div>
                    <div id="pointsDistribution" class="pokemon-leaderboard">
                        <h3>Points Distribution Breakdown</h3>
                        <table>
                            <tr><th>Category</th><th>Points</th></tr>
                            <tr><td>1st Place</td><td>${pointsByType['1st']}</td></tr>
                            <tr><td>Redemptions</td><td>${pointsByType['Redemptions']}</td></tr>
                            <tr><td>Other</td><td>${pointsByType['Other']}</td></tr>
                        </table>
                    </div>
                    <div id="pokeMart" class="pokemon-leaderboard">
                        <h3>Poké Mart Spending Overview</h3>
                        <table>
                            <tr><th>Category</th><th>Value</th></tr>
                            <tr><td>Points Spent</td><td>${totalSpent}</td></tr>
                            <tr><td>Popular Item</td><td>${mostPopularItem}</td></tr>
                            <tr><td>Remaining Points</td><td>${remainingPoints} <progress value="${Math.abs(totalSpent)}" max="${totalPoints}"></progress></td></tr>
                        </table>
                    </div>
                    <div id="recentHighlights" class="pokemon-leaderboard">
                        <h3>Recent Tournament Highlights</h3>
                        <table>
                            <tr><th>Category</th><th>Value</th></tr>
                            <tr><td>Latest Date</td><td>${new Date(latestDate).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' }) || 'N/A'}</td></tr>
                            <tr><td>Winner</td><td>${latestWinner || 'N/A'}</td></tr>
                            <tr><td>Total Points</td><td>${latestTotalPoints || 0}</td></tr>
                        </table>
                    </div>
                    <div id="achievementSpotlight" class="pokemon-leaderboard">
                        <h3>Achievement Spotlight</h3>
                        <table>
                            <tr><th>Player</th><th>Achievement</th><th>Count</th></tr>
                            <tr><td>${achievementSpotlight || 'N/A'}</td><td>P.Streak</td><td>${achievementCount || 0}</td></tr>
                        </table>
                    </div>
                    <button class="back-button game-btn" onclick="backToHome()">Back to Home</button>
                `;
                document.getElementById('overviewView').classList.remove('hidden');
                setTimeout(() => document.getElementById('overviewView').classList.add('fade-in'), 10);
            }

            // Reuse existing getTournamentWinner function
            function getTournamentWinner(date) {
                const entries = data.filter(e => e.date === date && !e.isRedemption);
                const players = {};
                entries.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                return Object.values(players).sort((a, b) => b.total - a.total)[0]?.name || null;
            }

            // Reuse or add generateFunFact (from previous context)
            function generateFunFact() {
                const trollFacts = [
                    `Rumor has it ${getPlayerWithMost('1st')} won ${getPlayerAchievementCount(getPlayerWithMost('1st'), '1st')} times with a lucky Charmander! 🔥😂`,
                    ` ${currentPlayers[0]?.name} is sitting on ${currentPlayers[0]?.total} points—time to challenge them! 💪😱`
                ];
                document.getElementById('funFactText').innerHTML = `<p>${trollFacts[Math.floor(Math.random() * trollFacts.length)]}</p>`;
            }

            function showPlayerComparison() {
                debugLog('Showing player comparison');
                hideAll();
                comparePlayers();
                document.getElementById('playerComparisonView').classList.remove('hidden');
                setTimeout(() => document.getElementById('playerComparisonView').classList.add('fade-in'), 10);
            }

            function showTournamentHistory() {
                debugLog('Showing tournament history');
                hideAll();
                document.getElementById('historyTimeline').innerHTML = '';
                document.getElementById('tournamentHistoryView').classList.remove('hidden');
                setTimeout(() => document.getElementById('tournamentHistoryView').classList.add('fade-in'), 10);
            }

            function showFunFact() {
                debugLog('Showing fun fact');
                hideAll();
                generateFunFact();
                document.getElementById('funFactView').classList.remove('hidden');
                setTimeout(() => document.getElementById('funFactView').classList.add('fade-in'), 10);
            }

            function hideAll() {
                document.querySelectorAll('.section:not(.hidden)').forEach(el => {
                    el.classList.add('fade-out');
                    setTimeout(() => {
                        el.classList.add('hidden');
                        el.classList.remove('fade-out', 'fade-in');
                    }, 300);
                });
            }

            function renderLeaderboard() {
                debugLog(`Rendering leaderboard, data length: ${data.length}`);
                const searchTerm = document.getElementById('leaderboardSearch').value.trim().toLowerCase();
                const players = {};
                data.filter(e => !e.isRedemption).forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                data.filter(e => e.isRedemption).forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                currentPlayers = Object.values(players).sort((a, b) => b.total - a.total);
                if (searchTerm) currentPlayers = currentPlayers.filter(p => p.name.toLowerCase().includes(searchTerm));
                const totalPages = Math.ceil(currentPlayers.length / entriesPerPage);
                const start = (currentPage - 1) * entriesPerPage;
                const end = start + entriesPerPage;
                const paginatedPlayers = currentPlayers.slice(start, end);
                const tbody = document.getElementById('leaderboardTable').querySelector('tbody');
                tbody.innerHTML = '';
                if (paginatedPlayers.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="3">No players found.</td>';
                    tbody.appendChild(tr);
                } else {
                    paginatedPlayers.forEach((p, index) => {
                        const globalIndex = start + index + 1;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${globalIndex}</td><td><a href="#" onclick="showPlayerDetails('${p.name}', 1)">${p.name}</a></td><td>${p.total}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
                document.getElementById('firstPage').disabled = currentPage === 1;
                document.getElementById('prevPage').disabled = currentPage === 1;
                document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
                document.getElementById('lastPage').disabled = currentPage === totalPages || totalPages === 0;
            }

            function filterLeaderboard() {
                currentPage = 1;
                renderLeaderboard();
            }

            function showPlayerDetails(player, page = 1) {
                debugLog(`Showing details for player: ${player}, page: ${page}`);
                currentDetailsPage = page;
                document.getElementById('playerDetailsName').textContent = `${player} Details`;
                const entries = data.filter(e => e.player.toLowerCase() === player.toLowerCase()).sort((a, b) => new Date(b.date) - new Date(a.date));
                const totalPages = Math.ceil(entries.length / detailsPerPage);
                const start = (currentDetailsPage - 1) * detailsPerPage;
                const end = start + detailsPerPage;
                const paginatedEntries = entries.slice(start, end);
                const tbody = document.getElementById('detailsTable').querySelector('tbody');
                tbody.innerHTML = '';
                const playerStats = { totalPoints: 0, achievements: { '1st': 0, '2nd': 0, '3rd': 0, 'B.Challenge': 0, 'S.Challenge': 0, 'P.Streak': 0, 'P.Participant': 0, 'Shared': 0, 'No s.s.': 0, 'Penalty': 0 } };
                entries.forEach(entry => { playerStats.totalPoints += entry.points || 0; for (let ach in playerStats.achievements) if (entry.achievements[ach]) playerStats.achievements[ach]++; });
                const profileCard = document.getElementById('playerProfileCard');
                profileCard.innerHTML = `<div class="pokemon-card-content"><h4>${player}'s Profile</h4><p>Total Points: ${playerStats.totalPoints}</p><p>Achievements: 1st x${playerStats.achievements['1st']}, 2nd x${playerStats.achievements['2nd']}, 3rd x${playerStats.achievements['3rd']}</p><p>B.Challenge x${playerStats.achievements['B.Challenge']}, S.Challenge x${playerStats.achievements['S.Challenge']}</p><p>P.Streak x${playerStats.achievements['P.Streak']}, Participant x${playerStats.achievements['P.Participant']}</p></div>`;
                if (paginatedEntries.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="13">No entries found for this player.</td>';
                    tbody.appendChild(tr);
                } else {
                    paginatedEntries.forEach(entry => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${normalizeDate(entry.date)}</td><td>${entry.achievements['P.Streak'] ? 'O' : 'X'}</td><td>${entry.achievements['P.Participant'] ? 'O' : 'X'}</td><td>${entry.achievements['1st'] ? 'O' : 'X'}</td><td>${entry.achievements['2nd'] ? 'O' : 'X'}</td><td>${entry.achievements['3rd'] ? 'O' : 'X'}</td><td>${entry.achievements['B.Challenge'] ? 'O' : 'X'}</td><td>${entry.achievements['S.Challenge'] ? 'O' : 'X'}</td><td>${entry.achievements['Shared'] ? 'O' : 'X'}</td><td>${entry.achievements['No s.s.'] ? 'O' : 'X'}</td><td>${entry.achievements['Penalty'] ? 'O' : 'X'}</td><td>${entry.isRedemption ? (entry.items || []).map(item => `${item.name} (x${item.quantity || 1})`).join('<br>') : '-'}</td><td>${entry.points}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('detailsPageInfo').textContent = `Page ${currentDetailsPage} of ${totalPages || 1}`;
                document.getElementById('firstDetailsPage').disabled = currentDetailsPage === 1;
                document.getElementById('prevDetailsPage').disabled = currentDetailsPage === 1;
                document.getElementById('nextDetailsPage').disabled = currentDetailsPage === totalPages || totalPages === 0;
                document.getElementById('lastDetailsPage').disabled = currentDetailsPage === totalPages || totalPages === 0;
                document.getElementById('playerDetails').classList.remove('hidden');
                setTimeout(() => document.getElementById('playerDetails').classList.add('fade-in'), 10);
            }

            function changePage(direction) {
                const totalPages = Math.ceil(currentPlayers.length / entriesPerPage);
                if (direction === 0) currentPage = 1;
                else if (direction === 999) currentPage = totalPages || 1;
                else currentPage += direction;
                currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
                renderLeaderboard();
            }

            function changeDetailsPage(direction) {
                const player = document.getElementById('playerDetailsName').textContent.replace(' Details', '');
                const entries = data.filter(e => e.player.toLowerCase() === player.toLowerCase());
                const totalPages = Math.ceil(entries.length / detailsPerPage);
                if (direction === 0) currentDetailsPage = 1;
                else if (direction === 999) currentDetailsPage = totalPages || 1;
                else currentDetailsPage += direction;
                currentDetailsPage = Math.max(1, Math.min(currentDetailsPage, totalPages || 1));
                showPlayerDetails(player, currentDetailsPage);
            }

            function backToLeaderboard() {
                document.getElementById('playerDetails').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('playerDetails').classList.add('hidden');
                    document.getElementById('playerDetails').classList.remove('fade-out', 'fade-in');
                    renderLeaderboard();
                }, 300);
            }

            function getTrainerRank(points) {
                if (points < 500) return 'Newbie';
                if (points < 1000) return 'Pokéball';
                if (points < 2000) return 'Greatball';
                if (points < 3000) return 'Ultraball';
                return 'Masterball';
            }

            function getTournamentWinner(date) {
                const entries = data.filter(e => e.date === date && !e.isRedemption);
                const players = {};
                entries.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                return Object.values(players).sort((a, b) => b.total - a.total)[0]?.name || null;
            }

            function getTournamentTotalPoints(date) {
                return data.filter(e => e.date === date).reduce((sum, entry) => sum + (entry.points || 0), 0);
            }

            function updateFilteredPlayers() {
                const players = {};
                data.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                filteredPlayers = Object.values(players).sort((a, b) => b.total - a.total);
                populatePlayerSelect();
            }

            function populatePlayerSelect() {
                const player1Select = document.getElementById('player1Select');
                const player2Select = document.getElementById('player2Select');
                [player1Select, player2Select].forEach(select => {
                    select.innerHTML = '<option value="">Select Player</option>';
                    filteredPlayers.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = p.name;
                        select.appendChild(option);
                    });
                });
            }

            function populateDateSelect() {
                const dates = [...new Set(data.map(entry => entry.date))].sort();
                const dateSelect = document.getElementById('dateSelect');
                dateSelect.innerHTML = '<option value="">Select Date</option>';
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' });
                    dateSelect.appendChild(option);
                });
            }

            function comparePlayers() {
                const player1Name = document.getElementById('player1Select').value;
                const player2Name = document.getElementById('player2Select').value;
                if (!player1Name || !player2Name || player1Name === player2Name) {
                    document.getElementById('comparisonResult').innerHTML = '<h3>Battle Arena</h3><p>Select two different players for an epic battle!</p>';
                    return;
                }
                const p1Data = data.filter(e => e.player.toLowerCase() === player1Name.toLowerCase());
                const p2Data = data.filter(e => e.player.toLowerCase() === player2Name.toLowerCase());
                const p1Total = p1Data.reduce((sum, e) => sum + (e.points || 0), 0);
                const p2Total = p2Data.reduce((sum, e) => sum + (e.points || 0), 0);
                const p1Ach = { '1st': 0, '2nd': 0, '3rd': 0, 'B.Challenge': 0, 'S.Challenge': 0 };
                const p2Ach = { '1st': 0, '2nd': 0, '3rd': 0, 'B.Challenge': 0, 'S.Challenge': 0 };
                p1Data.forEach(e => { for (let ach in p1Ach) if (e.achievements[ach]) p1Ach[ach]++; });
                p2Data.forEach(e => { for (let ach in p2Ach) if (e.achievements[ach]) p2Ach[ach]++; });
                const recentP1 = p1Data.sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.points || 0;
                const recentP2 = p2Data.sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.points || 0;
                document.getElementById('comparisonResult').innerHTML = `
                    <h3>Battle Arena</h3>
                    <div class="battle-stats">
                        <div class="player-stats"><h4>${player1Name}</h4><p>Points: ${p1Total} (${getTrainerRank(p1Total)})</p><p>Recent: ${recentP1} pts</p><p>Achievements: 1st x${p1Ach['1st']}, 2nd x${p1Ach['2nd']}, 3rd x${p1Ach['3rd']}</p></div>
                        <div class="player-stats"><h4>${player2Name}</h4><p>Points: ${p2Total} (${getTrainerRank(p2Total)})</p><p>Recent: ${recentP2} pts</p><p>Achievements: 1st x${p2Ach['1st']}, 2nd x${p2Ach['2nd']}, 3rd x${p2Ach['3rd']}</p></div>
                    </div>
                    <div class="battle-outcome">${p1Total > p2Total ? `${player1Name} wins!` : p2Total > p1Total ? `${player2Name} wins!` : 'It\'s a tie!'}</div>
                `;
            }

            function filterHistory() {
                const date = document.getElementById('dateSelect').value;
                const historyTimeline = document.getElementById('historyTimeline');
                if (!date) {
                    historyTimeline.innerHTML = '<p class="pokedex-entry">Select a date to view tournament history!</p>';
                    return;
                }
                const entries = data.filter(e => e.date === date);
                const players = {};
                entries.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!players[playerLower]) players[playerLower] = { name: entry.player, total: 0 };
                    players[playerLower].total += (entry.points || 0);
                });
                historyTimeline.innerHTML = Object.values(players).sort((a, b) => b.total - a.total).map(p => `
                    <div class="pokedex-entry">
                        <h4>${p.name}</h4>
                        <p>Points: ${p.total}</p>
                    </div>
                `).join('');
            }

            function generateFunFact() {
                if (!data || data.length === 0) {
                    document.getElementById('funFactText').innerHTML = `<h3>Troll Pokémon Note</h3><p>No data available yet—check back after the tournament starts! 😄</p>`;
                    return;
                }
                const trollFacts = [
                    `Behold the Pokémon Master ${getPlayerWithMost('1st') || 'N/A'} with ${getPlayerAchievementCount(getPlayerWithMost('1st') || '', '1st') || 0} epic 1st wins—bow to the champ! 😂`,
                    `Richest trainer ${currentPlayers[0]?.name || 'N/A'} hoards ${currentPlayers[0]?.total || 0} points—time to raid their Poké Bank! 💰😱`,
                    `This tournament raked in ${data.reduce((sum, e) => sum + (e.points || 0), 0)} points—someone’s printing Poké Dollars! 💸😂`,
                    `Clumsy ${getPlayerWithMost('No s.s.') || 'N/A'} forgot to save ${getPlayerAchievementCount(getPlayerWithMost('No s.s.') || '', 'No s.s.') || 0} times—Game Over! 😅`,
                    `Streak king ${getPlayerWithMost('P.Streak') || 'N/A'} nailed ${getPlayerAchievementCount(getPlayerWithMost('P.Streak') || '', 'P.Streak') || 0} P.Streaks—unstoppable! 🔥🤣`,
                    `Challenge Master ${getPlayerWithMostChallenges() || 'N/A'} conquered ${getPlayerChallengeCount(getPlayerWithMostChallenges() || '') || 0} challenges (B + S)—legend status! ⚔️😎`,
                    `Penalty prone ${getPlayerWithMost('Penalty') || 'N/A'} tripped ${getPlayerAchievementCount(getPlayerWithMost('Penalty') || '', 'Penalty') || 0} times—watch your step! 🚶‍♂️😂`
                ];
                document.getElementById('funFactText').innerHTML = `<h3>Troll Pokémon Note</h3><p>${trollFacts[Math.floor(Math.random() * trollFacts.length)]}</p>`;
            }

            function getPlayerAchievementCount(playerName, achievement) {
                return data.filter(e => 
                    e.player.toLowerCase() === playerName.toLowerCase() && e.achievements[achievement]
                ).length;
            }

            function getPlayerWithMost(achievement) {
                const counts = {};
                data.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!counts[playerLower]) counts[playerLower] = 0;
                    if (entry.achievements[achievement]) counts[playerLower]++;
                });
                return Object.entries(counts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
            }

            function getPlayerTotalPoints(playerName) {
                return data.filter(e => e.player.toLowerCase() === playerName.toLowerCase())
                    .reduce((sum, e) => sum + (e.points || 0), 0);
            }

            function getPlayerWithMostRedemptionPoints() {
                const totals = {};
                data.filter(e => e.isRedemption).forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!totals[playerLower]) totals[playerLower] = 0;
                    totals[playerLower] += (entry.points || 0);
                });
                return Object.entries(totals).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
            }

            function getPlayerChallengeCount(playerName) {
                const playerData = data.filter(e => e.player.toLowerCase() === playerName.toLowerCase());
                return playerData.filter(e => e.achievements['B.Challenge'] || e.achievements['S.Challenge']).length;
            }

            function getPlayerWithMostChallenges() {
                const totals = {};
                data.forEach(entry => {
                    const playerLower = entry.player.toLowerCase();
                    if (!totals[playerLower]) totals[playerLower] = 0;
                    if (entry.achievements['B.Challenge'] || entry.achievements['S.Challenge']) totals[playerLower]++;
                });
                return Object.entries(totals).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
            }

            function showFunFact() {
                debugLog('Showing fun fact');
                hideAll();
                generateFunFact(); // Ensure this runs after data is loaded
                document.getElementById('funFactView').classList.remove('hidden');
                setTimeout(() => document.getElementById('funFactView').classList.add('fade-in'), 10);
            }

            document.addEventListener('DOMContentLoaded', () => {
                debugLog('Page loaded, initializing leaderboard');
                loadData().then(() => {
                    // Ensure currentPlayers is populated after data load
                    renderLeaderboard();
                });
            });
        </script>
    </div>
</body>
</html>
